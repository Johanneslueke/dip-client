# MdB Stammdaten Import Tool - SQLC Implementation

## Overview

The import tool has been refactored to use **sqlc-generated Go bindings** instead of manual SQL statements. This provides:

- **Type safety**: Compile-time checking of SQL queries
- **Code generation**: Automatic generation of Go structs and methods
- **Maintainability**: SQL queries in separate `.sql` files
- **Consistency**: Same pattern as other project tools

## Implementation Details

### SQL Queries Location

```
internal/database/queries/sqlite/mdb_stammdaten.sql
```

Contains all queries for:

- Version management
- Person CRUD operations
- Name management
- Biographical data
- Wahlperiode membership
- Institution membership
- Complex queries and views
- Statistics

### Generated Go Code

```
internal/database/gen/sqlite/mdb_stammdaten.sql.go
```

Generated by sqlc, contains:

- `CreateMdbStammdatenVersionParams`
- `CreateMdbPersonParams`
- `CreateMdbNameParams`
- `CreateMdbBiographical Params`
- `CreateMdbWahlperiodeMembershipParams`
- `CreateMdbInstitutionMembershipParams`
- All query methods on `*Queries` type

### Key Changes from Manual SQL

#### Before (Manual SQL)

```go
stmt, err := tx.Prepare(`
    INSERT INTO mdb_person (id, created_at, updated_at)
    VALUES (?, ?, ?)
`)
_, err := stmt.Exec(mdb.ID, now, now)
```

#### After (SQLC)

```go
err := qtx.CreateMdbPerson(ctx, db.CreateMdbPersonParams{
    ID:        mdb.ID,
    CreatedAt: nowStr,
    UpdatedAt: nowStr,
})
```

### Type Mapping

| SQL Type           | Go Type          | Notes                                   |
| ------------------ | ---------------- | --------------------------------------- |
| `TEXT NOT NULL`    | `string`         | Required, use empty string for no value |
| `TEXT`             | `sql.NullString` | Optional, use `nullString()` helper     |
| `INTEGER NOT NULL` | `int64`          | Required                                |
| `INTEGER`          | `sql.NullInt64`  | Optional                                |

### Null Handling

The tool includes a helper function:

```go
func nullString(s string) sql.NullString {
    if s == "" {
        return sql.NullString{Valid: false}
    }
    return sql.NullString{String: s, Valid: true}
}
```

Used for optional XML fields:

```go
Ortszusatz: nullString(name.Ortszusatz),  // Optional
Nachname:   name.Nachname,                // Required
```

### Transaction Handling

```go
// Begin transaction
tx, err := sqlDB.BeginTx(ctx, nil)
defer tx.Rollback()

// Create queries with transaction context
qtx := queries.WithTx(tx)

// Use qtx for all operations
qtx.CreateMdbPerson(ctx, params)
qtx.CreateMdbName(ctx, params)

// Commit when done
tx.Commit()
```

## Query Examples

### Insert Operations (Used by Import Tool)

**Person**:

```sql
-- name: CreateMdbPerson :exec
INSERT INTO mdb_person (id, created_at, updated_at)
VALUES (?, ?, ?);
```

**Name** (with history):

```sql
-- name: CreateMdbName :exec
INSERT INTO mdb_name (
    mdb_id, nachname, vorname, ortszusatz, adel, praefix,
    anrede_titel, akad_titel, historie_von, historie_bis,
    created_at, updated_at
) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?);
```

**Wahlperiode** (returns ID for foreign key):

```sql
-- name: CreateMdbWahlperiodeMembership :one
INSERT INTO mdb_wahlperiode_membership (...)
VALUES (...)
RETURNING id;
```

### Query Operations (Available for Future Use)

**Search by name**:

```sql
-- name: SearchMdbByName :many
SELECT DISTINCT mp.id, mn.nachname, mn.vorname, ...
FROM mdb_person mp
JOIN mdb_name mn ON mp.id = mn.mdb_id
WHERE LOWER(mn.nachname) LIKE LOWER('%' || ? || '%')
LIMIT ? OFFSET ?;
```

**Get full details**:

```sql
-- name: GetMdbWithFullDetails :one
SELECT mp.id, mn.nachname, mn.vorname, mb.partei_kurz, ...
FROM mdb_person mp
JOIN mdb_name mn ON mp.id = mn.mdb_id
LEFT JOIN mdb_biographical mb ON mp.id = mb.mdb_id
WHERE mp.id = ?;
```

**Statistics**:

```sql
-- name: CountMdbPersons :one
SELECT COUNT(*) FROM mdb_person;

-- name: GetMdbStatsByWahlperiode :many
SELECT wp, COUNT(*) as anzahl_mitglieder, ...
FROM mdb_wahlperiode_membership
GROUP BY wp;
```

## Generating Code

After modifying `mdb_stammdaten.sql`:

```bash
cd internal/database
sqlc generate
```

This regenerates all Go bindings in `gen/sqlite/`.

## Benefits

1. **Type Safety**: Compilation fails if:

   - SQL query is invalid
   - Parameter types don't match
   - Return types are incorrect

2. **Auto-completion**: IDEs provide auto-complete for:

   - Query parameter names
   - Struct fields
   - Available queries

3. **Refactoring**: Easy to:

   - Add new queries
   - Modify existing queries
   - Rename fields (compile errors show all usage)

4. **Documentation**: SQL files serve as:
   - Query documentation
   - Schema reference
   - API contract

## Usage Example

```go
package main

import (
    db "github.com/Johanneslueke/dip-client/internal/database/gen/sqlite"
)

func example() {
    // Open database
    sqlDB, _ := sql.Open("sqlite", "dip.clean.db")
    queries := db.New(sqlDB)
    ctx := context.Background()

    // Use generated queries
    version, _ := queries.GetLatestMdbStammdatenVersion(ctx)
    persons, _ := queries.SearchMdbByName(ctx, db.SearchMdbByNameParams{
        Column1: "Schmidt",
        Column2: "Schmidt",
        Column3: "",
        Column4: "",
        Limit:   10,
        Offset:  0,
    })

    stats, _ := queries.CountMdbPersons(ctx)
}
```

## Migration Checklist

When adding new MdB Stammdaten features:

- [ ] Add SQL query to `queries/sqlite/mdb_stammdaten.sql`
- [ ] Run `sqlc generate`
- [ ] Use generated `db.*Params` structs in Go code
- [ ] Handle nullable fields with `sql.NullString` / `sql.NullInt64`
- [ ] Use timestamps as strings (RFC3339 format)
- [ ] Test with actual database

## Files Modified

1. **New**: `internal/database/queries/sqlite/mdb_stammdaten.sql` (40+ queries)
2. **Generated**: `internal/database/gen/sqlite/mdb_stammdaten.sql.go` (~1300 lines)
3. **Updated**: `cmd/import-mdb-stammdaten/main.go` (uses sqlc, not manual SQL)

## Performance

- Same performance as manual SQL (generated code uses standard library)
- Prepared statements handled by sqlc internally
- Transaction support for bulk operations
- No runtime reflection or ORM overhead

## See Also

- SQLC Documentation: https://docs.sqlc.dev/
- Project sqlc.yaml: `internal/database/sqlc.yaml`
- Other query files: `internal/database/queries/sqlite/*.sql`
- Generated code: `internal/database/gen/sqlite/*.go`
